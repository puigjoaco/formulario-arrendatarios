<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Datos - Arrendatarios Grupo 2</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .form-container {
            padding: 40px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }
        
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        select,
        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4facfe;
            background: white;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }
        
        select {
            cursor: pointer;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            margin-right: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }
        
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        #dataForm {
            display: none;
        }
        
        .instructions {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .required {
            color: red;
        }
        
        .info-card {
            background-color: #e8f8e8;
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .info-card h3 {
            color: #28a745;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        .info-card .info-row {
            display: flex;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .info-card .info-label {
            font-weight: bold;
            color: #555;
            width: 150px;
            flex-shrink: 0;
        }
        
        .info-card .info-value {
            color: #333;
            flex: 1;
            word-break: break-word;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4facfe;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .form-container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã Formulario de Datos - Grupo 2</h1>
            <p>Complete sus datos de contacto</p>
        </div>
        
        <div class="form-container">
            <div class="instructions">
                <h3>üìå Instrucciones:</h3>
                <ol>
                    <li>Seleccione su nombre del listado</li>
                    <li>Ingrese su RUT para verificar su identidad</li>
                    <li>Complete los datos solicitados</li>
                    <li>Haga clic en "Enviar Datos"</li>
                </ol>
            </div>
            
            <div id="initialForm">
                <div class="form-group">
                    <label for="nombre">Seleccione su Nombre: <span class="required">*</span></label>
                    <select id="nombre" required>
                        <option value="">-- Seleccione su nombre --</option>
                        <option value="001|Inversiones Dickinson SpA|77.234.562-3">Local 001 - Inversiones Dickinson SpA</option>
                        <option value="002|Novena Green Solutions SpA|78.100.943-1">Local 002 - Novena Green Solutions SpA</option>
                        <option value="004|Astrid Zamora Ascanio|26.964.083-9">Local 004 - Astrid Zamora Ascanio</option>
                        <option value="005|Jose Iba√±ez|Sin Rut / Sin Factura">Local 005 - Jose Iba√±ez</option>
                        <option value="006|Saavedra y Reyes SpA|76.960.061-2">Local 006 - Saavedra y Reyes SpA</option>
                        <option value="007|Inversiones Dickinson SpA|77.234.562-3">Local 007 - Inversiones Dickinson SpA</option>
                        <option value="008|La Bodeguita Verde|76.600.115-7">Local 008 - La Bodeguita Verde</option>
                        <option value="009|Kropka Tatoo Supply SpA|77.520.203-3">Local 009 - Kropka Tatoo Supply SpA</option>
                        <option value="010|Recimed SpA|78.096.907-5">Local 010 - Recimed SpA</option>
                        <option value="011|BMG SpA|77.930.277-6">Local 011 - BMG SpA</option>
                        <option value="012|Lady Studio SpA|78.202.055-2">Local 012 - Lady Studio SpA</option>
                        <option value="013|Golden Pacific S.A.|76.435.789-2">Local 013 - Golden Pacific S.A.</option>
                        <option value="016|Gustavo Andr√©s Carrasco Sandoval|18.720.341-4">Local 016 - Gustavo Andr√©s Carrasco Sandoval</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="rutVerificacion">Ingrese su RUT para verificaci√≥n: <span class="required">*</span></label>
                    <input type="text" id="rutVerificacion" placeholder="Ej: 12.345.678-9 o Sin Rut / Sin Factura" required>
                </div>
                
                <button onclick="verificarAcceso()">Verificar y Continuar</button>
            </div>
            
            <div id="dataForm">
                <div class="alert alert-success">
                    <strong>‚úÖ Verificaci√≥n exitosa!</strong> Por favor complete los siguientes datos:
                </div>
                
                <div class="info-card">
                    <h3>üìã Resumen de sus datos</h3>
                    <div class="info-row">
                        <span class="info-label">Local N¬∞:</span>
                        <span class="info-value" id="infoLocal"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Nombre:</span>
                        <span class="info-value" id="infoNombre"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">RUT:</span>
                        <span class="info-value" id="infoRut"></span>
                    </div>
                    <div class="info-row" id="infoTipoRow" style="display: none;">
                        <span class="info-label">Tipo:</span>
                        <span class="info-value" id="infoTipo"></span>
                    </div>
                    <div class="info-row" id="infoTelefonoRow" style="display: none;">
                        <span class="info-label">Tel√©fono:</span>
                        <span class="info-value" id="infoTelefono"></span>
                    </div>
                    <div class="info-row" id="infoEmailRow" style="display: none;">
                        <span class="info-label">Email:</span>
                        <span class="info-value" id="infoEmail"></span>
                    </div>
                    <div class="info-row" id="infoRegionRow" style="display: none;">
                        <span class="info-label">Regi√≥n:</span>
                        <span class="info-value" id="infoRegion"></span>
                    </div>
                    <div class="info-row" id="infoCiudadRow" style="display: none;">
                        <span class="info-label">Ciudad:</span>
                        <span class="info-value" id="infoCiudad"></span>
                    </div>
                    <div class="info-row" id="infoDireccionRow" style="display: none;">
                        <span class="info-label">Direcci√≥n:</span>
                        <span class="info-value" id="infoDireccion"></span>
                    </div>
                    <div class="info-row" id="infoDepartamentoRow" style="display: none;">
                        <span class="info-label">Departamento:</span>
                        <span class="info-value" id="infoDepartamento"></span>
                    </div>
                    <div class="info-row" id="infoRepresentanteRow" style="display: none;">
                        <span class="info-label">Rep. Legal:</span>
                        <span class="info-value" id="infoRepresentante"></span>
                    </div>
                    <div class="info-row" id="infoRutRepresentanteRow" style="display: none;">
                        <span class="info-label">RUT Rep.:</span>
                        <span class="info-value" id="infoRutRepresentante"></span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="tipo">Tipo <span class="required">*</span></label>
                    <select id="tipo" required>
                        <option value="">-- Seleccione el tipo --</option>
                        <option value="Empresa">Empresa</option>
                        <option value="Persona Natural">Persona Natural</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="representante">Representante Legal</label>
                    <input type="text" id="representante" placeholder="Nombre del representante legal">
                </div>

                <div class="form-group">
                    <label for="rutRepresentante">RUT del Representante</label>
                    <input type="text" id="rutRepresentante" placeholder="Ej: 12.345.678-9">
                </div>

                <div class="form-group">
                    <label for="telefono">Tel√©fono del Representante Legal</label>
                    <input type="tel" id="telefono" placeholder="Ej: +56 9 1234 5678">
                </div>

                <div class="form-group">
                    <label for="email">Correo Electr√≥nico del Representante Legal</label>
                    <input type="email" id="email" placeholder="ejemplo@correo.com">
                </div>

                <div class="form-group">
                    <label for="direccion">Direcci√≥n <span class="required">*</span></label>
                    <input type="text" id="direccion" placeholder="Calle, avenida, pasaje" required>
                </div>

                <div class="form-group">
                    <label for="numero">N√∫mero <span class="required">*</span></label>
                    <input type="text" id="numero" placeholder="N√∫mero de la direcci√≥n" required>
                </div>

                <div class="form-group">
                    <label for="departamento">Departamento/Oficina</label>
                    <input type="text" id="departamento" placeholder="Depto, oficina, casa (opcional)">
                </div>

                <div class="form-group">
                    <label for="ciudad">Ciudad <span class="required">*</span></label>
                    <input type="text" id="ciudad" placeholder="Ingrese su ciudad" required>
                </div>

                <div class="form-group">
                    <label for="region">Regi√≥n <span class="required">*</span></label>
                    <select id="region" required>
                        <option value="">-- Seleccione Regi√≥n --</option>
                        <option value="Arica y Parinacota">Arica y Parinacota</option>
                        <option value="Tarapac√°">Tarapac√°</option>
                        <option value="Antofagasta">Antofagasta</option>
                        <option value="Atacama">Atacama</option>
                        <option value="Coquimbo">Coquimbo</option>
                        <option value="Valpara√≠so">Valpara√≠so</option>
                        <option value="Metropolitana de Santiago">Metropolitana de Santiago</option>
                        <option value="O'Higgins">O'Higgins</option>
                        <option value="Maule">Maule</option>
                        <option value="√ëuble">√ëuble</option>
                        <option value="Biob√≠o">Biob√≠o</option>
                        <option value="La Araucan√≠a">La Araucan√≠a</option>
                        <option value="Los R√≠os">Los R√≠os</option>
                        <option value="Los Lagos">Los Lagos</option>
                        <option value="Ays√©n">Ays√©n</option>
                        <option value="Magallanes">Magallanes</option>
                    </select>
                </div>
                
                <div class="loading" id="loadingMessage">
                    <div class="spinner"></div>
                    Enviando sus datos...
                </div>
                
                <button onclick="guardarDatos()" id="submitBtn">üì§ Enviar Datos</button>
                <button onclick="volverInicio()" class="btn-secondary">üîô Volver</button>
            </div>
            
            <div id="mensaje"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDiMgABeT-o0grleNAn9KEFhhqgyT13Nqc",
            authDomain: "arrendatarios-datos.firebaseapp.com",
            projectId: "arrendatarios-datos",
            storageBucket: "arrendatarios-datos.firebasestorage.app",
            messagingSenderId: "79764229076",
            appId: "1:79764229076:web:25b4f6c346070781a46441"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let datosSeleccionados = null;

        function mostrarMensaje(mensaje, tipo = 'info') {
            const mensajeDiv = document.getElementById('mensaje');
            mensajeDiv.innerHTML = `<div class="alert alert-${tipo}">${mensaje}</div>`;
            setTimeout(() => {
                mensajeDiv.innerHTML = '';
            }, 5000);
        }

        window.verificarAcceso = function() {
            const selectElement = document.getElementById('nombre');
            const rutIngresado = document.getElementById('rutVerificacion').value.trim();
            
            if (!selectElement.value) {
                mostrarMensaje('Por favor seleccione su nombre', 'error');
                return;
            }
            
            if (!rutIngresado) {
                mostrarMensaje('Por favor ingrese su RUT', 'error');
                return;
            }
            
            const [local, nombre, rutEsperado] = selectElement.value.split('|');
            
            // Normalizar RUTs para comparaci√≥n
            const rutIngresadoNormalizado = rutIngresado.replace(/\./g, '').toUpperCase().trim();
            const rutEsperadoNormalizado = rutEsperado.replace(/\./g, '').toUpperCase().trim();
            
            if (rutIngresadoNormalizado === rutEsperadoNormalizado) {
                datosSeleccionados = {
                    local: local,
                    nombre: nombre,
                    rut: rutEsperado
                };
                
                // Actualizar la tarjeta de informaci√≥n
                document.getElementById('infoLocal').textContent = local;
                document.getElementById('infoNombre').textContent = nombre;
                document.getElementById('infoRut').textContent = rutEsperado;
                
                document.getElementById('initialForm').style.display = 'none';
                document.getElementById('dataForm').style.display = 'block';
                
                // Inicializar la actualizaci√≥n del resumen
                actualizarTarjeta();
            } else {
                mostrarMensaje('El RUT ingresado no coincide con el registrado. Por favor verifique.', 'error');
            }
        }

        window.guardarDatos = async function() {
            if (!datosSeleccionados) {
                mostrarMensaje('Error: No se han verificado los datos', 'error');
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            const loadingMessage = document.getElementById('loadingMessage');
            
            // Mostrar loading
            submitBtn.disabled = true;
            loadingMessage.style.display = 'block';
            
            try {
                // Validaciones de campos obligatorios
                const tipo = document.getElementById('tipo').value;
                const region = document.getElementById('region').value;
                const ciudad = document.getElementById('ciudad').value.trim();
                const direccion = document.getElementById('direccion').value.trim();
                const numero = document.getElementById('numero').value.trim();
                
                if (!tipo) {
                    mostrarMensaje('Por favor seleccione el tipo (Empresa o Persona Natural)', 'error');
                    submitBtn.disabled = false;
                    loadingMessage.style.display = 'none';
                    return;
                }
                
                if (!region) {
                    mostrarMensaje('Por favor seleccione su regi√≥n', 'error');
                    submitBtn.disabled = false;
                    loadingMessage.style.display = 'none';
                    return;
                }
                
                if (!ciudad) {
                    mostrarMensaje('Por favor ingrese su ciudad', 'error');
                    submitBtn.disabled = false;
                    loadingMessage.style.display = 'none';
                    return;
                }
                
                if (!direccion) {
                    mostrarMensaje('Por favor ingrese su direcci√≥n', 'error');
                    submitBtn.disabled = false;
                    loadingMessage.style.display = 'none';
                    return;
                }
                
                if (!numero) {
                    mostrarMensaje('Por favor ingrese el n√∫mero de su direcci√≥n', 'error');
                    submitBtn.disabled = false;
                    loadingMessage.style.display = 'none';
                    return;
                }
                
                const datos = {
                    numeroLocal: datosSeleccionados.local,
                    nombre: datosSeleccionados.nombre,
                    rut: datosSeleccionados.rut,
                    tipo: tipo,
                    telefono: document.getElementById('telefono').value.trim() || '-',
                    email: document.getElementById('email').value.trim() || '-',
                    region: region,
                    ciudad: ciudad,
                    direccion: direccion,
                    numero: numero,
                    departamento: document.getElementById('departamento').value.trim() || '-',
                    representanteLegal: document.getElementById('representante').value.trim() || '-',
                    rutRepresentante: document.getElementById('rutRepresentante').value.trim() || '-',
                    fechaEnvio: serverTimestamp(),
                    formulario: 'grupo2',
                    ip: await obtenerIP()
                };
                
                // Guardar en Firestore
                const docRef = await addDoc(collection(db, 'arrendatarios'), datos);
                console.log('Documento guardado con ID: ', docRef.id);
                
                loadingMessage.style.display = 'none';
                mostrarMensaje('¬°Datos guardados exitosamente!', 'success');
                
                // Limpiar formulario despu√©s de 3 segundos
                setTimeout(() => {
                    volverInicio();
                }, 3000);
                
            } catch (error) {
                console.error('Error al guardar los datos: ', error);
                loadingMessage.style.display = 'none';
                submitBtn.disabled = false;
                mostrarMensaje('Error al enviar los datos. Por favor intente nuevamente.', 'error');
            }
        }

        window.volverInicio = function() {
            document.getElementById('initialForm').style.display = 'block';
            document.getElementById('dataForm').style.display = 'none';
            document.getElementById('nombre').value = '';
            document.getElementById('rutVerificacion').value = '';
            document.getElementById('tipo').value = '';
            document.getElementById('telefono').value = '';
            document.getElementById('email').value = '';
            document.getElementById('region').value = '';
            document.getElementById('ciudad').value = '';
            document.getElementById('direccion').value = '';
            document.getElementById('numero').value = '';
            document.getElementById('departamento').value = '';
            document.getElementById('representante').value = '';
            document.getElementById('rutRepresentante').value = '';
            document.getElementById('submitBtn').disabled = false;
            datosSeleccionados = null;
        }
        
        // Actualizar tarjeta din√°micamente
        function actualizarTarjeta() {
            // Tipo
            const tipo = document.getElementById('tipo').value;
            if (tipo.trim()) {
                document.getElementById('infoTipo').textContent = tipo;
                document.getElementById('infoTipoRow').style.display = 'flex';
            } else {
                document.getElementById('infoTipoRow').style.display = 'none';
            }
            
            // Tel√©fono
            const telefono = document.getElementById('telefono').value;
            if (telefono.trim()) {
                document.getElementById('infoTelefono').textContent = telefono;
                document.getElementById('infoTelefonoRow').style.display = 'flex';
            } else {
                document.getElementById('infoTelefonoRow').style.display = 'none';
            }
            
            // Email
            const email = document.getElementById('email').value;
            if (email.trim()) {
                document.getElementById('infoEmail').textContent = email;
                document.getElementById('infoEmailRow').style.display = 'flex';
            } else {
                document.getElementById('infoEmailRow').style.display = 'none';
            }
            
            // Regi√≥n
            const region = document.getElementById('region').value;
            if (region.trim()) {
                document.getElementById('infoRegion').textContent = region;
                document.getElementById('infoRegionRow').style.display = 'flex';
            } else {
                document.getElementById('infoRegionRow').style.display = 'none';
            }
            
            // Ciudad
            const ciudad = document.getElementById('ciudad').value;
            if (ciudad.trim()) {
                document.getElementById('infoCiudad').textContent = ciudad;
                document.getElementById('infoCiudadRow').style.display = 'flex';
            } else {
                document.getElementById('infoCiudadRow').style.display = 'none';
            }
            
            // Direcci√≥n completa
            const direccion = document.getElementById('direccion').value;
            const numero = document.getElementById('numero').value;
            if (direccion.trim() || numero.trim()) {
                const direccionCompleta = `${direccion.trim()} ${numero.trim()}`.trim();
                document.getElementById('infoDireccion').textContent = direccionCompleta;
                document.getElementById('infoDireccionRow').style.display = 'flex';
            } else {
                document.getElementById('infoDireccionRow').style.display = 'none';
            }
            
            // Departamento
            const departamento = document.getElementById('departamento').value;
            if (departamento.trim()) {
                document.getElementById('infoDepartamento').textContent = departamento;
                document.getElementById('infoDepartamentoRow').style.display = 'flex';
            } else {
                document.getElementById('infoDepartamentoRow').style.display = 'none';
            }
            
            // Representante Legal
            const representante = document.getElementById('representante').value;
            if (representante.trim()) {
                document.getElementById('infoRepresentante').textContent = representante;
                document.getElementById('infoRepresentanteRow').style.display = 'flex';
            } else {
                document.getElementById('infoRepresentanteRow').style.display = 'none';
            }
            
            // RUT Representante
            const rutRepresentante = document.getElementById('rutRepresentante').value;
            if (rutRepresentante.trim()) {
                document.getElementById('infoRutRepresentante').textContent = rutRepresentante;
                document.getElementById('infoRutRepresentanteRow').style.display = 'flex';
            } else {
                document.getElementById('infoRutRepresentanteRow').style.display = 'none';
            }
        }
        
        // Agregar event listeners cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            // Agregar evento a cada campo para actualizar la tarjeta
            document.getElementById('tipo').addEventListener('change', actualizarTarjeta);
            document.getElementById('telefono').addEventListener('input', actualizarTarjeta);
            document.getElementById('email').addEventListener('input', actualizarTarjeta);
            document.getElementById('region').addEventListener('change', actualizarTarjeta);
            document.getElementById('ciudad').addEventListener('input', actualizarTarjeta);
            document.getElementById('direccion').addEventListener('input', actualizarTarjeta);
            document.getElementById('numero').addEventListener('input', actualizarTarjeta);
            document.getElementById('departamento').addEventListener('input', actualizarTarjeta);
            document.getElementById('representante').addEventListener('input', actualizarTarjeta);
            document.getElementById('rutRepresentante').addEventListener('input', actualizarTarjeta);
        });
        
        // Funci√≥n para obtener IP (opcional)
        async function obtenerIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                return 'No disponible';
            }
        }
    </script>
</body>
</html>
